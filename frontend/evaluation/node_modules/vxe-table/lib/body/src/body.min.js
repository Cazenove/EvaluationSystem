"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,_xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var l=0,t=new Array(e.length);l<e.length;l++)t[l]=e[l];return t}}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function countTreeExpand(e,l){var t=l.$table,o=e[t.treeOpts.children],r=1;if(t.isTreeExpandByRow(e))for(var n=0;n<o.length;n++)r+=countTreeExpand(o[n],l);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,l){var t=e.$table,o=e.$rowIndex,r=1;return o&&(r=countTreeExpand(l[o-1],e)),t.rowHeight*r-(o?1:12-getOffsetSize(t))}function renderLine(e,l,t,o,r,n){var i=n.column,s=t.treeOpts,c=t.treeConfig;return i.slots&&i.slots.line?i.slots.line.call(t,n,e):i.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,r),"px"),left:"".concat(o*s.indent+(o?2-getOffsetSize(t):0)+16,"px")}})])]:[]}function renderBorder(e,l){return e("div",{class:"vxe-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(l,"Left")})])}function renderColumn(e,l,t,o,r,n,i,s,c,a,d,u,p,f,v,x){var y,m,g=t._e,w=t.$listeners,h=t.tableData,b=t.height,_=t.columnKey,T=t.overflowX,$=t.scrollXLoad,S=t.scrollYLoad,C=t.highlightCurrentRow,O=t.showOverflow,L=t.align,I=t.currentColumn,E=t.cellClassName,k=t.cellStyle,R=t.spanMethod,q=t.radioOpts,B=t.checkboxOpts,U=t.expandOpts,P=t.treeOpts,A=t.mouseConfig,D=t.mouseOpts,H=t.editConfig,M=t.editOpts,N=t.editRules,X=t.validOpts,z=t.editStore,W=t.validStore,Y=u.editRender,j=u.align,F=u.showOverflow,K=u.className,G=u.treeNode,V=z.actived,J=A&&D.selected,Q=A&&(D.range||D.checked),Z=i?u.fixed!==i:u.fixed&&T,ee=_xeUtils.default.isUndefined(F)||_xeUtils.default.isNull(F)?O:F,le="ellipsis"===ee,te="title"===ee,oe=!0===ee||"tooltip"===ee,re=te||oe||le,ne={},ie=j||L,se=W.row===c&&W.column===u,ce=N&&("default"===X.message?b||1<h.length:"inline"===X.message),ae={"data-colid":u.id},de=Y&&H&&"dblclick"===M.trigger,ue={$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Z,level:s,data:h,items:x};if(!$&&!S||re||(le=re=!0),(te||oe||w["cell-mouseenter"])&&(ne.mouseenter=function(e){isOperateMouse(t)||(te?_tools.DomTools.updateCellTitle(e):oe&&t.triggerTooltipEvent(e,ue),_tools.UtilTools.emitEvent(t,"cell-mouseenter",[{$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Z,level:s,data:h,items:x,cell:e.currentTarget,$event:e},e]))}),(oe||w["cell-mouseleave"])&&(ne.mouseleave=function(e){isOperateMouse(t)||(oe&&t.handleTargetLeaveEvent(e),_tools.UtilTools.emitEvent(t,"cell-mouseleave",[{$table:t,$seq:o,seq:r,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,isHidden:Z,level:s,data:h,items:x,cell:e.currentTarget,$event:e},e]))}),(B.range||Q||J)&&(ne.mousedown=function(e){t.triggerCellMousedownEvent(e,ue)}),(C||w["cell-click"]||Q||Y&&H||"row"===U.trigger||"cell"===U.trigger||"row"===q.trigger||"radio"===u.type&&"cell"===q.trigger||"row"===B.trigger||("checkbox"===u.type||"selection"===u.type)&&"cell"===B.trigger||"row"===P.trigger||u.treeNode&&"cell"===P.trigger)&&(ne.click=function(e){t.triggerCellClickEvent(e,ue)}),(de||w["cell-dblclick"])&&(ne.dblclick=function(e){t.triggerCellDBLClickEvent(e,ue)}),R){var pe=R(ue)||{},fe=pe.rowspan,ve=void 0===fe?1:fe,xe=pe.colspan,ye=void 0===xe?1:xe;if(!ve||!ye)return null;ae.rowspan=ve,ae.colspan=ye}!Z&&Y&&H&&M.showStatus&&(m=t.isUpdateByRow(c,u.property));var me="seq"===u.type||"index"===u.type?"seq":u.type;return e("td",{class:["vxe-body--column",u.id,(_defineProperty(y={},"col--".concat(ie),ie),_defineProperty(y,"col--".concat(me),me),_defineProperty(y,"col--last",f===v.length-1),_defineProperty(y,"col--tree-node",G),_defineProperty(y,"col--edit",!!Y),_defineProperty(y,"col--ellipsis",re),_defineProperty(y,"edit--visible",Y&&"visible"===Y.type),_defineProperty(y,"fixed--hidden",Z),_defineProperty(y,"col--dirty",m),_defineProperty(y,"col--actived",H&&Y&&V.row===c&&(V.column===u||"row"===M.mode)),_defineProperty(y,"col--valid-error",se),_defineProperty(y,"col--current",I===u),y),_tools.UtilTools.getClass(K,ue),_tools.UtilTools.getClass(E,ue)],key:_?u.id:f,attrs:ae,style:k?_xeUtils.default.isFunction(k)?k(ue):k:null,on:ne},O&&Z?[e("div",{class:["vxe-cell",{"c--title":te,"c--tooltip":oe,"c--ellipsis":le}]})]:renderLine(e,l,t,s,x,ue).concat([e("div",{class:["vxe-cell",{"c--title":te,"c--tooltip":oe,"c--ellipsis":le}],attrs:{title:te?_tools.UtilTools.getCellLabel(c,u,ue):null}},u.renderCell(e,ue)),ce?se?e("div",{class:"vxe-cell--valid",style:W.rule&&W.rule.maxWidth?{width:"".concat(W.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},W.content)]):g():null]))}function renderRows(u,p,f,v,x,y,m,g){var w=f.stripe,h=f.rowKey,b=f.highlightHoverRow,_=f.rowClassName,T=f.rowStyle,$=f.showOverflow,S=f.treeConfig,C=f.treeOpts,O=f.treeExpandeds,L=f.scrollYLoad,I=f.scrollYStore,E=f.editStore,k=f.rowExpandeds,R=f.radioOpts,q=f.checkboxOpts,B=f.expandColumn,U=f.getColumnIndex,P=[];return m.forEach(function(o,r){var e={},n=r,i=n+1;L&&(i+=I.startIndex),n=f.getRowIndex(o),b&&(e.mouseenter=function(e){isOperateMouse(f)||f.triggerHoverEvent(e,{row:o,rowIndex:n})},e.mouseleave=function(){isOperateMouse(f)||f.clearHoverRow()});var s=_tools.UtilTools.getRowid(f,o);if(P.push(u("tr",{class:["vxe-body--row",{"row--stripe":w&&(f._getRowIndex(o)+1)%2==0,"is--new":-1<E.insertList.indexOf(o),"row--radio":R.highlight&&f.selectRow===o,"row--cheched":q.highlight&&f.isCheckedByCheckboxRow(o)},_?_xeUtils.default.isFunction(_)?_({$table:f,$seq:v,seq:i,rowid:s,fixedType:y,rowLevel:x,row:o,rowIndex:n,$rowIndex:r}):_:""],attrs:{"data-rowid":s},style:T?_xeUtils.default.isFunction(T)?T({$table:f,$seq:v,seq:i,rowid:s,fixedType:y,rowLevel:x,row:o,rowIndex:n,$rowIndex:r}):T:null,key:h||S?s:r,on:e},g.map(function(e,l){var t=U(e);return renderColumn(u,p,f,v,i,s,y,x,o,n,r,e,t,l,g,m)}))),k.length&&-1<k.indexOf(o)){var l,t=U(B);if(S&&(l={paddingLeft:"".concat(x*C.indent+30,"px")}),B){var c=B.showOverflow,a=_xeUtils.default.isUndefined(c)||_xeUtils.default.isNull(c)?$:c;P.push(u("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:T?_xeUtils.default.isFunction(T)?T({$table:f,$seq:v,seq:i,rowid:s,fixedType:y,rowLevel:x,row:o,rowIndex:n,$rowIndex:r,isExpanded:!0}):T:null,on:e},[u("td",{class:["vxe-body--expanded-column",{"fixed--hidden":y,"col--ellipsis":a}],attrs:{colspan:g.length}},[u("div",{class:"vxe-body--expanded-cell",style:l},[B.renderData(u,{$table:f,seq:i,rowid:s,row:o,rowIndex:n,column:B,columnIndex:t,fixed:y,level:x})])])]))}}if(S&&O.length){var d=o[C.children];d&&d.length&&-1<O.indexOf(o)&&P.push.apply(P,_toConsumableArray(renderRows(u,p,f,v?"".concat(v,".").concat(i):"".concat(i),x+1,y,d,g)))}}),P}function syncBodyScroll(e,l,t){(l||t)&&(l&&(l.onscroll=null,l.scrollTop=e),t&&(t.onscroll=null,t.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),t&&(t.onscroll=t._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,o=this.fixedType,r=e.elemStore,n="".concat(o||"main","-body-");r["".concat(n,"wrapper")]=l,r["".concat(n,"table")]=t.table,r["".concat(n,"colgroup")]=t.colgroup,r["".concat(n,"list")]=t.tbody,r["".concat(n,"xSpace")]=t.xSpace,r["".concat(n,"ySpace")]=t.ySpace,r["".concat(n,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(t){var e,l=this._e,o=this.$parent,r=this.fixedColumn,n=this.fixedType,i=o.$scopedSlots,s=o.id,c=o.tableData,a=o.tableColumn,d=o.showOverflow,u=o.spanMethod,p=o.scrollXLoad,f=o.mouseConfig,v=o.mouseOpts,x=o.emptyRender,y=o.emptyOpts,m=o.keyboardConfig,g=void 0===m?{}:m,w=f&&(v.range||v.checked);if(u||(n&&d?a=r:p&&n&&(a=r)),i.empty)e=i.empty.call(this,{$table:this},t);else{var h=x?_vXETable.default.renderer.get(y.name):null;e=h&&h.renderEmpty?h.renderEmpty.call(this,t,y,{$table:this},{$table:this}):_conf.default.i18n("vxe.table.emptyText")}return t("div",{class:["vxe-table--body-wrapper",n?"fixed-".concat(n,"--wrapper"):"body--wrapper"],attrs:{"data-tid":s}},[n?l():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{"data-tid":s,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},a.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,o,"",0,n,c,a))]),n||!w&&!g.isCut?null:t("div",{class:"vxe-table--borders"},[w?renderBorder(t,"check"):null,g.isCut?renderBorder(t,"copy"):null]),n?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var l=this.$parent,t=this.fixedType,o=l.$refs,r=l.highlightHoverRow,n=l.scrollXLoad,i=l.scrollYLoad,s=l.lastScrollTop,c=l.lastScrollLeft,a=o.tableHeader,d=o.tableBody,u=o.leftBody,p=o.rightBody,f=o.tableFooter,v=a?a.$el:null,x=f?f.$el:null,y=d.$el,m=u?u.$el:null,g=p?p.$el:null,w=y.scrollTop,h=y.scrollLeft,b=h!==c,_=w!==s;l.lastScrollTop=w,l.lastScrollLeft=h,l.lastScrollTime=Date.now(),r&&l.clearHoverRow(),m&&"left"===t?syncBodyScroll(w=m.scrollTop,y,g):g&&"right"===t?syncBodyScroll(w=g.scrollTop,y,m):(b&&(v&&(v.scrollLeft=y.scrollLeft),x&&(x.scrollLeft=y.scrollLeft)),(m||g)&&(l.checkScrolling(),_&&syncBodyScroll(w,m,g))),n&&b&&(l.triggerScrollXEvent(e),v&&h+y.clientWidth>=y.scrollWidth-80&&this.$nextTick(function(){y.scrollLeft!==v.scrollLeft&&(v.scrollLeft=y.scrollLeft)})),i&&_&&l.triggerScrollYEvent(e),_tools.UtilTools.emitEvent(l,"scroll",[{type:"body",fixed:t,scrollTop:w,scrollLeft:h,isX:b,isY:_,$table:l,$event:e},e])}}};exports.default=_default;